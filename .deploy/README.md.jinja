# {{ app_name | title }} Deployment

æ­¤ç›®å½•åŒ…å« {{ app_name }} çš„æ‰€æœ‰éƒ¨ç½²é…ç½®å’Œè„šæœ¬ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
.deploy/
â”œâ”€â”€ Dockerfile              # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ .dockerignore          # Docker å¿½ç•¥è§„åˆ™
â”œâ”€â”€ Makefile               # Make å‘½ä»¤ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ build-and-deploy.yml  # CI/CD æµæ°´çº¿
â”œâ”€â”€ terraform/             # Terraform IaCï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ terraform.tf
â”‚   â””â”€â”€ main.tf
â””â”€â”€ scripts/               # ä¾¿æ·è„šæœ¬
    â”œâ”€â”€ build.sh           # æ„å»ºäºŒè¿›åˆ¶
    â”œâ”€â”€ run.sh             # æœ¬åœ°è¿è¡Œ
    â”œâ”€â”€ docker-build.sh    # Docker æ„å»º
    â”œâ”€â”€ docker-push.sh     # Docker æ¨é€
    â””â”€â”€ deploy.sh          # Terraform éƒ¨ç½²
```

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æ„å»ºäºŒè¿›åˆ¶
.deploy/scripts/build.sh

# æœ¬åœ°è¿è¡Œ
.deploy/scripts/run.sh

# Docker æ„å»º
.deploy/scripts/docker-build.sh

# Docker æ¨é€
TAG=v1.0.0 .deploy/scripts/docker-push.sh

# Terraform éƒ¨ç½²
.deploy/scripts/deploy.sh init
.deploy/scripts/deploy.sh plan
.deploy/scripts/deploy.sh apply
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Makefile

```bash
cd .deploy

# å¼€å‘
make build
make run
make test

# Docker
make docker-build
make docker-push

# Terraform
make terraform-init
make terraform-plan
make terraform-apply
```

## âš™ï¸ é…ç½®

ä¸»é…ç½®æ–‡ä»¶ä½äºé¡¹ç›®æ ¹ç›®å½•ï¼š`../.deploy.yml`

ä¿®æ”¹é…ç½®åï¼Œæ›´æ–°ç›¸å…³æ–‡ä»¶ï¼š
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
copier update
```

## ğŸ”§ GitHub Actions

### å¯ç”¨ CI/CD

ä½¿ç”¨ä¾¿æ·è„šæœ¬å¯ç”¨ GitHub Actionsï¼š

```bash
.deploy/scripts/enable-github-actions.sh
```

é€‰æ‹©åˆ›å»ºç¬¦å·é“¾æ¥æˆ–å¤åˆ¶æ–‡ä»¶åˆ°é¡¹ç›®æ ¹ç›®å½•ã€‚

### ç¦ç”¨ CI/CD

```bash
.deploy/scripts/disable-github-actions.sh
```

## ğŸ“ GitHub Secrets

éœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®ï¼š

- `ALIYUN_REGISTRY_USERNAME` - é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç”¨æˆ·å
- `ALIYUN_REGISTRY_PASSWORD` - é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡å¯†ç 
{% if enable_private_repos -%}
- `GH_TOKEN` - GitHub Personal Access Token
- `NETRC_LOGIN` - ç§æœ‰åŒ…ä»“åº“ç™»å½•
- `NETRC_PASSWORD` - ç§æœ‰åŒ…ä»“åº“å¯†ç 
- `NETRC_FILE` - .netrc æ–‡ä»¶å†…å®¹ï¼ˆbase64ï¼‰
{% endif -%}

## ğŸ—ï¸ Terraform éƒ¨ç½²

{% if enable_terraform -%}
```bash
cd terraform

# åˆå§‹åŒ–
terraform init

# æŸ¥çœ‹è®¡åˆ’
terraform plan{% if use_database %} -var="database_url=$DATABASE_URL"{% endif %}{% if use_redis %} -var="redis_url=$REDIS_URL"{% endif %}

# åº”ç”¨éƒ¨ç½²
terraform apply{% if use_database %} -var="database_url=$DATABASE_URL"{% endif %}{% if use_redis %} -var="redis_url=$REDIS_URL"{% endif %}
```
{% else -%}
Terraform æœªå¯ç”¨ã€‚è¦å¯ç”¨ï¼Œè¿è¡Œï¼š
```bash
copier update
```
{% endif -%}

## ğŸ³ Docker æ„å»ºè¯´æ˜

æ„å»ºä¸Šä¸‹æ–‡æ˜¯é¡¹ç›®æ ¹ç›®å½•ï¼Œæ‰€ä»¥ä» `.deploy/` ç›®å½•æ„å»ºæ—¶éœ€è¦ï¼š

```bash
cd ..  # å›åˆ°é¡¹ç›®æ ¹ç›®å½•
docker build -f .deploy/Dockerfile -t {{ app_name }}:latest .
```

è„šæœ¬å·²è‡ªåŠ¨å¤„ç†è·¯å¾„é—®é¢˜ã€‚

## ğŸ“Š å¥åº·æ£€æŸ¥

åº”ç”¨å¿…é¡»å®ç°å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š`{{ health_check_path }}`

ç¤ºä¾‹ï¼š
```go
http.HandleFunc("{{ health_check_path }}", func(w http.ResponseWriter, r *http.Request) {
    w.WriteHeader(http.StatusOK)
    w.Write([]byte("OK"))
})
```

## ğŸ” æ•…éšœæ’æŸ¥

### Docker æ„å»ºå¤±è´¥
- ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•æœ‰ `go.mod` å’Œ `go.sum`
- æ£€æŸ¥ `.deploy/.dockerignore` æ²¡æœ‰æ’é™¤å¿…è¦æ–‡ä»¶

### è„šæœ¬æ‰§è¡Œå¤±è´¥
- ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™ï¼š`chmod +x .deploy/scripts/*.sh`
- æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®

### CI/CD å¤±è´¥
- éªŒè¯ GitHub Secrets é…ç½®
- æ£€æŸ¥ `.github/workflows/` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æŸ¥çœ‹ GitHub Actions æ—¥å¿—

## ğŸ“š æ›´å¤šä¿¡æ¯

æŸ¥çœ‹é¡¹ç›®æ ¹ç›®å½•çš„æ–‡æ¡£æˆ–è®¿é—®ï¼š
- [Aliyun SAE](https://www.aliyun.com/product/sae)
- [Docker æ–‡æ¡£](https://docs.docker.com/)
- [Terraform æ–‡æ¡£](https://www.terraform.io/)

